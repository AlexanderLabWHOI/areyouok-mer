configfile: "config.yaml"

RAWFASTQFILES = config["fastqdumpdir"]
FASTQFILES = config["fastqdir"]
TRINITYFASTADIR = config["trinityfastadir"]
BLASTOUTDIR = config["blastoutdir"]

rule blast:
    input:
        raw = os.path.join(FASTQFILES, "{sample}.{ext}"),
        trinity = os.path.join(TRINITYFASTADIR, "{sample}.fasta")
    output:
        os.path.join(BLASTOUTDIR, "{sample}.{ext}.txt")
    log:
        "logs/trinity/outputlog_{sample}.{ext}_blast.log"
    params:
        inputname = "{sample}",
        outputdir = os.path.join(BLASTOUTDIR, "{sample}.{ext}.txt"),
        outputblast = os.path.join(BLASTOUTDIR, "{sample}.{ext}.txt"),
        blastdb = "{sample}_db"
    threads: 4
    shell:
        """
        #blastn -query {input.raw} -subject {input.trinity} -outfmt 6 -out {params.outputdir}
        makeblastdb -in {input.trinity} -dbtype nucl -parse_seqids -out {params.blastdb} -title {params.inputname}
        magicblast -query {input.raw} -db {params.blastdb} -out {params.outputblast} -infmt fastq -outfmt tabular
        rm {params.inputname}_db.*
        """